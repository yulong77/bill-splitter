<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bill Splitter</title>
  <style>
    :root{
      --bg: #f9fafb;
      --fg: #1a1a1a;
      --muted: #555;
      --card: #ffffff;
      --accent: #0077cc;
      --good: #2ca46f;
      --bad: #d32f2f;
      --warn: #e6a700;
      --border: #ddd;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin: 0;
      font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--fg);
      background: #fdfdfd;
    }
    .container{max-width:980px;margin:0 auto;padding:24px}
    h1{font-size:24px;margin:0 0 8px}
    h2{font-size:18px;margin:16px 0 8px;color:var(--muted)}
    p{color:var(--muted);margin:8px 0}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 4px 24px rgba(0,0,0,.25)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .grow{flex:1 1 240px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}

    .col-name   { width: 30%; }
    .col-sub    { width: 20%; text-align: right; }
    .col-note   { width: 20%; text-align: right; }
    .col-action { width: 30%; text-align: right; }
    
    input[type="text"],input[type="number"],select,textarea{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #d0d7de;
      background:#ffffff;
      color:#1f2937;
      outline:none;
      box-shadow: inset 0 1px 0 rgba(16,24,40,.02);
    }
    input::placeholder{ color:#9aa4b2; }

    input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(140,210,255,.2)}
    
    button{
      appearance:none;
      border:1px solid #d0d7de;
      background:#f6f8fa;
      color:#1f2937;
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      transition: background .15s ease, border-color .15s ease, transform .02s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    button:hover{
      background:#eef2f7;
      border-color:#c9d2dc;
    }

    button:hover{border-color:var(--accent)}
    button:active{transform:translateY(1px)}
    
    .btn-primary{
      background:#1677ff;
      border-color:#145fcc;
      color:#fff;
    }
    .btn-primary:hover{ background:#1567e6; }

    .btn-ghost{
      background:#ffffff;
      border-color:#d0d7de;
      color:#1f2937;
    }
    .btn-ghost:hover{
      background:#f2f4f7;
      border-color:#cfd8e3;
    }
    .btn-danger{
      background:#fee2e2;
      border-color:#f5c2c2;
      color:#8a1f1f;
    }
    .btn-danger:hover{
      background:#fbd5d5;
      border-color:#f0b1b1;
    }
    table{width:100%;border-collapse:collapse;border-spacing:0}
    th,td{padding:10px;border-bottom:1px dashed var(--border);text-align:left}
    th{font-weight:600;color:var(--muted)}
    tr:last-child td{border-bottom:none}
    .right{text-align:right}
    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      background:#f3f4f6;
      border:1px solid #e5e7eb;
      font-size:12px;
      color:#374151;
    }
    .totals{display:flex;flex-wrap:wrap;gap:12px;margin-top:8px}
    .totals .pill{background:#f3f4f6}
    .footer{opacity:.7;font-size:12px;margin-top:24px}
    .link{color:var(--accent);text-decoration:none}
    .success{color:var(--good)}
    .warn{color:var(--warn)}
    .error{color:var(--bad)}
    .flex{display:flex;gap:8px;align-items:center}
    .hint{font-size:12px;color:var(--muted)}
    .badge{
      font-size:12px;
      background:#eef2f7;
      border:1px solid #d6dee7;
      color:#334155;
      padding:2px 8px;
      border-radius:999px;
    }
    .spacer{height:6px}
  </style>
</head>

<body>
  <div class="container">
    <h1>Bill Splitter </h1>
    <p>Please enter your <strong>name</strong> and your <strong>pre-tax amount</strong> (menu price).</p>

    <div class="card">
      <h2>People & Subtotals</h2>
      <div class="row" id="addRow">
        <div class="grow">
          <label>Name<span style="color:red">*</span></label>
          <input id="nameInput" type="text" placeholder="e.g. Rick" />
        </div>
        <div style="width:200px">
          <label>Pre-tax subtotal<span style="color:red">*</span></label>
          <input id="amountInput" type="number" step="0.01" min="0" placeholder="e.g. 18.99" />
        </div>

        <div class="grow">
          <label>Note (optional)</label>
          <input id="noteInput" type="text" placeholder="e.g. Double Cheeseburger" />
        </div>

        <div style="width:180px;align-self:end">
          <button class="btn-primary" id="addBtn" style="width:120px; justify-content:center;">Add</button>
        </div>
      </div>

      <div class="spacer"></div>
      <table id="peopleTable">
        <thead>
          <tr>
            <th class="col-name">Name</th>
            <th class="col-sub">Subtotal</th>
            <th class="col-note">Note</th>
            <th class="col-action">Action</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div class="totals" id="preTotals"></div>
      <div class="row" style="margin-top:12px">
        <div class="grow">
          <button class="btn-danger" id="wipeBtn" title="Remove all local data, including totals and results">Delete All Data</button>
        </div>
        <div class="grow right hint">Data is automatically saved in local browser (localStorage).</div>
      </div>
    </div>

    <div class="spacer"></div>

    <div class="card">
      <h2>Total & Split</h2>
      <p class="hint" style="color:red; font-weight:bold;">
        For the final payer only.
      </p>
      <div class="row">
        <div class="grow" style="max-width:240px">
          <label>Paid Total (incl. tax & tip) <span style="color:red">*</span></label>
          <input id="grandTotal" type="number" step="0.01" min="0" placeholder="e.g. 256.78" required />
        </div>
        <div class="grow" style="max-width:220px">
          <label>Optional: Tax %</label>
          <input id="taxRate" type="number" step="0.01" min="0" placeholder="e.g. 9.375" />
        </div>
        <div class="grow" style="max-width:220px">
          <label>Optional: Tip %</label>
          <input id="tipRate" type="number" step="0.01" min="0" placeholder="e.g. 15" />
        </div>
        <div style="align-self:end">
          <button class="btn-primary" id="calcBtn" style="width:120px; justify-content:center;">Calculate</button>
        </div>
      </div>
      <p class="hint"><br>Paid Total is required. Tax% and Tip% are optional and only shown for reference.</p>
      <p class="hint">
        Bills are split proportionally by subtotal using. Final rounding is handled with the Largest Remainder Method so the total always matches.
      </p>
      <div id="results"></div>
    </div>

    <div class="footer">
      © 2025 Yulong · Bill Splitter · All rights reserved.
    </div>
  </div>

  <script>
    const AWS_CONFIG = {
      API_ENDPOINT: 'https://q92lnci0fg.execute-api.us-east-1.amazonaws.com/'
    };

    const $ = sel => document.querySelector(sel);
    const tbody = $('#tbody');
    const preTotals = $('#preTotals');
    let people = [];

    function money(n){
      return (Math.round((Number(n)||0)*100)/100).toFixed(2)
    }

    function render(){
      tbody.innerHTML = people.map((p,i)=>`
        <tr>
          <td>${escapeHtml(p.name||'')}</td>
          <td class="right">$${money(p.amount)}</td>
          <td class="col-note">${escapeHtml(p.note||'')}</td>
          <td class="right">
            <button data-i="${i}" class="btn-ghost edit">Edit</button>
            <button data-i="${i}" class="btn-danger del">Delete</button>
          </td>
        </tr>`).join('');

      const sum = people.reduce((a,b)=>a+(Number(b.amount)||0),0);
      preTotals.innerHTML = `
        <span class="pill">People: ${people.length}</span>
        <span class="pill">Subtotal sum: $${money(sum)}</span>`;
      save();
    }

    function escapeHtml(s){
      return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]))
    }

    async function save() {
      try {
        console.log('Starting save operation with data:', people);
        const response = await fetch(AWS_CONFIG.API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ people })
        });
        
        console.log('Response status:', response.status);
        const responseData = await response.text();
        console.log('Response data:', responseData);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        localStorage.setItem('bill_split_people', JSON.stringify(people));
        console.log('Save successful');
      } catch (err) {
        console.error('Save failed:', err);
        localStorage.setItem('bill_split_people', JSON.stringify(people));
      }
    }

    async function load() {
      try {
        // try cloud load first
        const response = await fetch(AWS_CONFIG.API_ENDPOINT);
        if (response.ok) {
          const data = await response.json();
          if (data.people && data.people.length > 0) {
            return data.people;
          }
        }
      } catch (err) {
        console.error('Cloud load failed:', err);
      }
      
      // fallback to localStorage
      try {
        return JSON.parse(localStorage.getItem('bill_split_people') || '[]');
      } catch {
        return [];
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const addBtn = $('#addBtn');
      if(addBtn) {
        addBtn.addEventListener('click', () => {
          console.log('Add button clicked'); // Debug log
          const nameInput   = $('#nameInput');
          const amountInput = $('#amountInput');
          const noteInput   = $('#noteInput');
          
          if(!nameInput || !amountInput) {
            console.error('Input elements not found');
            return;
          }
          
          const name = nameInput.value.trim();
          const amt = Number(amountInput.value);
          const note = noteInput ? noteInput.value.trim() : '';
          
          console.log('Input values:', {name, amt}); // Debug log
          
          if(!name) { 
            alert('Please enter name'); 
            return; 
          }
          if(!(amt>=0)) { 
            alert('Please enter valid amount'); 
            return; 
          }
          
          try {
            people.push({name, amount: amt, note: note});
            nameInput.value = '';
            amountInput.value = '';
            if(noteInput) noteInput.value = '';
            console.log('Person added:', {name, amount: amt}); // Debug log
            render();
          } catch(err) {
            console.error('Save failed:', err);
            alert('Save failed: ' + (err?.message || err));
            localStorage.setItem('bill_split_people', JSON.stringify(people));
          }
        });
      }
    });

    tbody.addEventListener('click', e=>{
      const i = e.target.getAttribute('data-i');
      if(i===null) return;
      if(e.target.classList.contains('del')){ people.splice(Number(i),1); render(); return; }
      if(e.target.classList.contains('edit')){
        const p = people[i];
        const name = prompt('Name', p.name);
        if(name===null) return;
        const amt = prompt('Subtotal (pre-tax)', p.amount);
        if(amt===null) return;
        const note = prompt('Note (optional)', p.note||'');
        if(name.trim()==='' || !(Number(amt)>=0)) return alert('Invalid input');
        people[i] = {name: name.trim(), amount: Number(amt), note: note||''};
        render();
      }
    });


    $('#wipeBtn').addEventListener('click',()=>{
      if(!confirm('Permanently delete all data on this device? This will clear the list, totals, localStorage and results.')) return;
      people = [];
      localStorage.removeItem('bill_split_people');
      render();
      ['grandTotal','taxRate','tipRate'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
      showResults('');
      toast('All data deleted');
    });

    function calcProportional(grandTotal){
      const base=people.map(p=>Number(p.amount)||0);
      const sumBase=base.reduce((a,b)=>a+b,0);
      if(!(grandTotal>0)) throw new Error('Please enter valid paid total (>0)');
      if(sumBase<=0) throw new Error('Subtotal sum must be >0');
      const raw=base.map(x=>grandTotal*x/sumBase);
      const flooredCents=raw.map(x=>Math.floor(x*100));
      const sumFloored=flooredCents.reduce((a,b)=>a+b,0);
      let remainder=Math.round(grandTotal*100)-sumFloored;
      const order=raw.map((x,i)=>({i,frac:x*100-Math.floor(x*100)})).sort((a,b)=>b.frac-a.frac);
      for(let k=0;k<order.length&&remainder>0;k++){flooredCents[order[k].i]+=1;remainder--;}
      return flooredCents.map(c=>c/100);
    }

    $('#calcBtn').addEventListener('click',()=>{
      const grand=Number($('#grandTotal').value);
      const taxPct=$('#taxRate').value.trim();
      const tipPct=$('#tipRate').value.trim();
      let shares;
      try{
        shares=calcProportional(grand);
      }catch(err){
        return showResults('<p class="error">⚠️ '+escapeHtml(err.message)+'</p>');
      }
      const res=people.map((p,i)=>({name:p.name,note:p.note,base:Number(p.amount)||0,pay:shares[i]}));
      const sumBase=res.reduce((a,b)=>a+b.base,0);
      const sumPay=res.reduce((a,b)=>a+b.pay,0);
      const rows=res.map(r=>`
         <tr>
           <td>${escapeHtml(r.name)}</td>
           <td class="right">$${money(r.base)}</td>
           <td class="right">$${money(r.pay - r.base)}</td>
           <td class="right">$${money(r.pay)}</td>
         </tr>`).join('');
       
      showResults(
        `<table>
           <thead>
            <tr>
              <th class="col-name">Name</th>
              <th class="col-sub">Subtotal</th>
              <th class="col-note">Tax+Tip</th>
              <th class="col-action">Pay</th>
            </tr>
           </thead>

           <tbody>${rows}</tbody>
         </table>
         <div class="totals">
           <span class="pill">Subtotal sum: $${money(sumBase)}</span>
           <span class="pill">Pay sum: $${money(sumPay)}</span>
           ${(taxPct!==''||tipPct!=='')?`<span class="pill">Tax: ${taxPct||0}%</span><span class="pill">Tip: ${tipPct||0}%</span>`:''}
         </div>
         <div class="row" style="margin-top:12px">
           <div class="grow"></div>
           <div>
             <button id="downloadBtn">Download CSV</button>
           </div>
         </div>`
      );
      $('#downloadBtn')?.addEventListener('click',()=>{
        const lines=['Name,Subtotal,Tax+Tip,Pay']
          .concat(res.map(r=>`${csv(r.name)},${money(r.base)},${money(r.pay - r.base)},${money(r.pay)}`));
        const blob=new Blob(["\ufeff"+lines.join('\n')],{type:'text/csv;charset=utf-8'});
        const a=document.createElement('a');
        a.href=URL.createObjectURL(blob);
        a.download='bill-split.csv';
        a.click();
        URL.revokeObjectURL(a.href);
      });
      
    });

    function csv(s){
      s = String(s||'');
      if(/[",\n]/.test(s)) return '"'+s.replace(/"/g,'""')+'"';
      return s;
    }

    function showResults(html){
      document.getElementById('results').innerHTML = html;
    }

    function toast(msg){
      const t=document.createElement('div');
      t.textContent=msg;
      t.style.cssText='position:fixed;left:50%;top:24px;transform:translateX(-50%);' +
                      'background:#ffffff;color:#1f2937;border:1px solid #e5e7eb;' +
                      'padding:8px 12px;border-radius:12px;box-shadow:0 8px 30px rgba(16,24,40,.08);z-index:9999';
      document.body.appendChild(t);
      setTimeout(()=>t.remove(),1400);
    }

    window.onload = async () => {
      people = await load();
      render();
    };
  </script>
</body>
</html>
